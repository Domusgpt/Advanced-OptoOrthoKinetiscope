# System Architecture: KineticLens v2.0

## 1. Architectural Pattern
KineticLens implements a **Unidirectional Data Flow** architecture specialized for high-frequency sensor fusion. The application logic is strictly separated into:
1.  **The Sensor Loop (60Hz):** `CaptureScreen.tsx` / `cpeMath.ts`
2.  **The State Machine:** `App.tsx`
3.  **The Render Pipeline:** `imageCompositor.ts`
4.  **The Inference Bridge:** `geminiService.ts`

## 2. Core Components

### 2.1 The Sensor Loop (`OrthogonalFilter`)
Located in `services/cpeMath.ts`, this class acts as the "Physics Engine".
*   **Input:** Raw `DeviceMotion` events.
*   **Process:**
    *   Maintains a rolling buffer of gravity vectors.
    *   Calculates the Principal Axis (Eigenvector of motion).
    *   Computes `VectorEfficiency`.
*   **Output:** A "Clean" `Vector3` acceleration used for both HUD visualization and AI analysis.
*   **Constraint:** Must execute in `<4ms` to maintain 60FPS render loop.

### 2.2 The Capture Buffer (`CaptureScreen.tsx`)
Because the Vision API is stateless, we must encapsulate all temporal context into a single payload.
*   **Buffer Structure:** `useRef<CapturePoint[]>`.
*   **Synchronization:** When the shutter fires (`grabFrame`), we assume the *current* sensor state applies to the *current* video frame.
    *   *Latency Compensation:* The `calibration.sensorReadoutLatency` variable (measured during setup) is used to offset the timestamp, aligning the photon capture time with the electron readout time.

### 2.3 The Holographic Compositor (`imageCompositor.ts`)
This component converts the temporal buffer into a spatial artifact.
*   **Input:** Array of JPEGs (Base64) + Telemetry Objects.
*   **Operation:** Uses HTML5 Canvas API to perform "Data Burning".
    *   It does NOT just draw text.
    *   It draws **Geometric Primitives** (Lines, Circles, Grids) that correspond to the sensor values.
*   **Why?** LLMs are better at "seeing" geometry (e.g., "The blue line crosses the red line") than they are at "reading" overlay text. We convert math into geometry.

## 3. Data Serialization & Export (`packageService.ts`)
To support "Offline Mode" and external audit, the system implements a zip-packaging protocol.
*   **Library:** `JSZip`.
*   **Artifacts:**
    1.  `composite_analysis_frame.jpg`: The fully rendered data-image.
    2.  `raw_session_data.json`: The complete `SessionData` object (dump of `types.ts`).
    3.  `INSTRUCTIONS_AND_PROMPT.txt`: The exact prompt string generated by `geminiService.ts`.
*   **Use Case:** This allows a user to capture data in the field (no internet) and perform the analysis later by uploading the files to a desktop LLM interface.

## 4. State Management (`types.ts`)
The `AppState` enum controls the high-level view routing.
```typescript
export enum AppState {
  IDLE,           // Landing
  INSTRUCTIONS,   // Permissions
  CALIBRATION,    // Sensor Zeroing
  CAPTURING,      // The 60Hz Loop
  ENCODING,       // Image Compositing
  PROCESSING,     // Gemini API Call
  ANALYZING,      // Decoding Response
  RESULTS         // Visualization
}
```
Transitions are linear and guarded. For example, you cannot enter `CAPTURING` without a valid `CalibrationData` object.

---

## 5. Advanced Modules (Evolution Track 3)

### 5.1 Geometric Algebra Engine (`GeometricAlgebra.ts`)
Implements Clifford Algebra Cl(3,0) for rotation representation.
- **Rotors**: Replace quaternions with geometrically-meaningful objects
- **Spinors**: Quantum state representation for Phillips Gate
- **4D Bi-Rotors**: Double isoclinic rotations for 4D polytope manipulation

See: [GEOMETRIC_ALGEBRA_PRIMER.md](./GEOMETRIC_ALGEBRA_PRIMER.md)

### 5.2 E8 Projection Engine (`E8Projection.ts`)
High-dimensional geometry for visual computation.
- **24-Cell**: Substrate for quantum register (Binary Tetrahedral Group)
- **600-Cell**: Extended substrate for cellular automaton
- **Hopf Fibration**: Quaternion visualization via S³ → S² projection
- **Quasicrystals**: Penrose/Ammann-Beenker tilings from cut-and-project

### 5.3 Moiré Visual Computing (`MoireEngine.ts`)
Replaces textual readouts with geometric patterns.
- **Gratings**: Linear, circular, log-polar, hyperbolic patterns
- **Nomograms**: Visual analog calculators (Time × Distance = Speed)
- **Fringe Analysis**: Mechanical amplification via beat frequency

See: [MOIRE_VISUAL_COMPUTING.md](./MOIRE_VISUAL_COMPUTING.md)

### 5.4 Phillips Gate Simulator (`PhillipsGateSimulator.ts`)
Quantum computing simulation on polytope substrate.
- **Vertex Qubits**: Each 24-cell vertex hosts a Bloch sphere
- **GA Rotors as Gates**: X, Y, Z, H, S, T gates implemented as rotors
- **Global Phillips Gate**: 4D bi-rotor applies coherent phase to all qubits
- **Simulated Annealing**: Energy minimization for optimization

See: [PHILLIPS_GATE_ARCHITECTURE.md](./PHILLIPS_GATE_ARCHITECTURE.md)

---

## 6. Module Dependency Graph

```
┌─────────────────────────────────────────────────────────────┐
│                       App.tsx                               │
│                   (State Machine)                           │
└─────────────────────────┬───────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
        ▼                 ▼                 ▼
┌───────────────┐ ┌───────────────┐ ┌───────────────┐
│ CaptureScreen │ │ CalibScreen   │ │ GhostView     │
│ (60Hz Loop)   │ │ (Setup)       │ │ (Parallax)    │
└───────┬───────┘ └───────────────┘ └───────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────────────┐
│                    services/                                  │
├───────────────┬───────────────┬───────────────┬──────────────┤
│ cpeMath.ts    │ imageCompos.  │ geminiSvc.    │ packageSvc.  │
│ (Physics)     │ (Render)      │ (AI Bridge)   │ (Export)     │
└───────┬───────┴───────┬───────┴───────────────┴──────────────┘
        │               │
        ▼               ▼
┌───────────────────────────────────────────────────────────────┐
│                 Evolution Track 3 Modules                     │
├───────────────┬───────────────┬───────────────┬──────────────┤
│ Geometric     │ E8Projection  │ MoireEngine   │ PhillipsGate │
│ Algebra       │ (Polytopes)   │ (Visual)      │ (Quantum)    │
└───────────────┴───────────────┴───────────────┴──────────────┘
```

---

## 7. Documentation Index

| Document | Purpose |
|----------|---------|
| [ARCHITECTURE.md](./ARCHITECTURE.md) | System overview (this file) |
| [THEORY_OF_OPERATION.md](./THEORY_OF_OPERATION.md) | Physics principles |
| [OPTO_ORTHO_GIMBAL.md](./OPTO_ORTHO_GIMBAL.md) | Gimbal compensation |
| [SYSTEMS_MANIFEST.md](./SYSTEMS_MANIFEST.md) | Subsystem specifications |
| [API_VARIABLES.md](./API_VARIABLES.md) | Constants and variables |
| [USER_MANUAL.md](./USER_MANUAL.md) | End-user guide |
| [ROADMAP.md](./ROADMAP.md) | Development roadmap |
| [GEOMETRIC_ALGEBRA_PRIMER.md](./GEOMETRIC_ALGEBRA_PRIMER.md) | GA mathematics |
| [MOIRE_VISUAL_COMPUTING.md](./MOIRE_VISUAL_COMPUTING.md) | Moiré theory |
| [PHILLIPS_GATE_ARCHITECTURE.md](./PHILLIPS_GATE_ARCHITECTURE.md) | Quantum simulation |
| [API_REFERENCE.md](./API_REFERENCE.md) | Complete API docs |
